<!DOCTYPE html>
<html lang="en">
<head>
    <link id="pagestyle" href="../assets/css/Layout.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Dashboard</title>
</head>
<body>
   <!--PC 네비바-->
    <nav class="nav-pc">
        <div class="hamburger-pc" id="hamburger-pc">☰</div>
        <ul class="nav-links" id="nav-links">
            <li><a href="./dashboard.html"><img src="../assets/img/bottom_icon03-w.png"></a></li>
            <li><a href="./beat-track.html"><img src="../assets/img/bottom_icon02-w.png"></a></li>
            <li><a href="./training-record.html"><img src="../assets/img/bottom_icon04-w.png"></a></li>
        </ul>
        <div class="nav-logout"><a href="./sitemap.html"></a><img src="../assets/img/bottom_icon05-w.png"></div>
    </nav>
    <!-- 모바일 네비바 -->
    <div class="bar">Heart Rate Monitor</div>
    <div class="hamburger-mob" id="hamburger-mob">☰</div> 
    <nav class="nav-mob" id="nav-mob">
        <a href="./dashboard.html">메인 보드</a>
        <a href="./beat-track.html">트레이닝</a>
        <a href="./training-record.html">트레이닝 기록</a>
    </nav>

    <!--pc 전용 레이아웃--><!--
    <div class="wrap-cont-pc">
        <div class="first-row">
            <div class="rt-heart-board"></div>
            <div class="status-container">
                <canvas></canvas>
                <div class="status-icon"><img src="../assets/img/normal.png" alt=""></div>
            </div>
            <div class="average-heart-board"></div>
        </div>
        <div class="second-row">
            <div class="donut-chart-container">

            </div>
            <div class="bar-chart-container">

            </div>
        </div>
        <div class="third-row">
            <div class="chart-container"></div>
        </div>
    </div>-->

    <!--모바일 전용 레이아웃-->
    <div class="wrap-cont">
        <h1>(로그인사용자) <div class="status"><img src="../assets/img/normal.png" id="dynamicImage"></div></h1>
        <div class="dash-board">
            <div class="heart-board">         
                <ul>
                    <li><img src="../assets/img/heart-shape.png" alt=""></li>
                    <li><div class="heart-rate-container-big">
                        <div class="heart-rate">Real Time</div>
                        <div class="heart-rate"><span class="real-time">
                            <div id="bpmValue">0</div></span></div>
                    </li>
                </ul>
            </div>
            <div class="scroll-board" data-simplebar>
    
                <div class="heart-rate-container">
                <div class="heart-rate">1분 평균</div>
                <div class="heart-rate">
                    <div id="minbpmContainer">0</div></div></div>
            
                <div class="heart-rate-container">
                <div class="heart-rate">1시간 평균</div>
                <div class="heart-rate">
                    <div id="hourbpmContainer"> 0</div></div></div>
        
                <div class="heart-rate-container">
                <div class="heart-rate">하루 평균</div>
                <div class="heart-rate">
                    <div id="daybpmContainer"> 0</div></div></div>

                <div class="heart-rate-container">
                <div class="heart-rate">주 평균</div>
                <div class="heart-rate">
                    <div id="weekbpmContainer"> 0</div></div></div>

                <div class="heart-rate-container">
                <div class="heart-rate">한 달 평균</div>
                <div class="heart-rate">
                    <div id="monthbpmContainer"> 0</div></div></div>

                <div class="heart-rate-container">
                <div class="heart-rate">연 평균</div>
                <div class="heart-rate">
                    <div id="yearbpmContainer"> 0</div></div></div>
                 
    
            </div>
                   
        </div>
    
        <div class="chart-container-main">
            <div class="container-title-main">심박수 평균</div>

            <ul class="button-container">
                <li class="button active"><a href="#">Daily</a></li>
                <li class="button"><a href="#">Weekly</a></li>
                <li class="button"><a href="#">Monthly</a></li>
            </ul>
                
            <canvas id="graph" width="1000" height="400"></canvas>

        </div>
        <div class="chart-container" data-simplebar style="overflow-x: auto; overflow-y:hidden; white-space:nowrap;" >
            <div class="container-title" style="padding-top: 0;">안정활동휴식</div>
            <canvas id="bar-graph" width="1000" height="350" style="padding-bottom: 20px;"></canvas>
        </div>
        <div class="chart-container">
            <div class="container-title">안정활동휴식 </div>
            <canvas id="donut-graph" width="1000" height="350"></canvas>
            <img id="centerIcon" src="" alt="Icon" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        </div>

        <div class="footer">
            <div class="footer-nav">
                <ul class="d-flex justify-content-around">
                    <li class="footer-logout"><a href="/logout"> 로그아웃 </a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="bottom_icon">
        <ul>
            <li>
                <a href="../index.html"><img src="../assets/img/bottom_icon01.png"></a></li>
            <li>
                <a href="./beat-track.html"><img src="../assets/img/bottom_icon02.png"></a></li>            
            <li>
                <a href="./dashboard.html"><img src="../assets/img/bottom_icon03.png"></a></li>
            <li>
                <a href="./training-record.html"><img src="../assets/img/bottom_icon04.png"></a></li>
            <li>
                <a href="./sitemap.html"><img src="../assets/img/bottom_icon05.png"></a></li>
        </ul>
    </div>
    
</body>
<script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>
    <script src="../assets/js/core/popper.min.js"></script>
    <script src="../assets/js/core/bootstrap.min.js"></script>
    <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
    <script src="../assets/js/plugins/chartjs.min.js"></script>

    <script src="../assets/js/HR-update.js"></script>

    <script> //태그값 변경시 아이콘 변경 스크립트
        function fetchDynamicIconData() {
            fetch('/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    var serverTag = data.tag; // 서버에서 받은 태그 값

                    // 이미지 요소 선택
                    var imgElement = document.getElementById("dynamicImage");

                    // 태그 값이 'workout'인지 확인하고 이미지 src 변경
                    if (serverTag === "workout") {
                        imgElement.src = "../assets/img/workout.png";
                    }
                    else if (serverTag === "rest") {
                        imgElement.src = "../assets/img/rest.png";
                    }
                    else if (serverTag === "sleep") {
                        imgElement.src = "../assets/img/sleep.png";
                    }
                    else if (serverTag === "normal") {
                        imgElement.src = "../assets/img/normal.png";
                    }
                })
                .catch(error => {
                    console.error('Error fetching status data:', error);
                    var imgElement = document.getElementById("dynamicImage");
                    imgElement.src = "../assets/img/loading.gif";
                });
        };
        
        setInterval(fetchDynamicIconData,1000);
        document.addEventListener('DOMContentLoaded', fetchDynamicIconData);
    </script>


    <script> //모바일네비바 펼치기스크립트
        document.getElementById('hamburger-mob').addEventListener('click', function() {
            document.getElementById('nav-mob').classList.toggle('open');
        });
    </script>
    <script>
        //로그아웃 버튼 클릭 이벤트 리스너 추가
        document.querySelector('.logout').addEventListener('click', function() {
            fetch('/logout', { //클릭 시 서버로 로그아웃 요청을 보냄
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    // 로그아웃 성공 시, 홈 페이지로 리디렉션
                    window.location.href = 'https://heartrate.ddns.net';
                } else {
                    // 로그아웃 실패 시, 에러 메시지 출력
                    alert('로그아웃에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error during logout:', error);
                alert('로그아웃 중 에러가 발생했습니다.');
            });
        });
    </script>


    <script>
        // 버튼 클릭 이벤트 리스너 추가
        document.querySelector('.button-container').addEventListener('click', function(event) {
            if (event.target.tagName === 'A') {
                event.preventDefault(); // 기본 동작 방지
                
                // 모든 버튼을 비활성화 상태로 초기화
                document.querySelectorAll('.button').forEach(function(button) {
                    button.classList.remove('active');
                });
                
                // 클릭한 버튼을 활성화 상태로 변경
                event.target.parentElement.classList.add('active');

                // 클릭한 버튼에 따라 다른 URL로 데이터 요청
                let url;
                const buttonText = event.target.textContent.trim();

                if (buttonText === 'Daily') {
                    url = '/hourly-chart';
                } else if (buttonText === 'Weekly') {
                    url = '/weekly-chart';
                } else if (buttonText === 'Monthly') {
                    url = '/monthly-chart';
                }

                // 데이터 요청 및 차트 업데이트
                fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(responseData => {
                    const { userEmail, data } = responseData;
                    console.log('User Email:', userEmail); // 추가된 userEmail을 로그에 출력
                    updateChart(data);
                })
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                });
            }
        });

        // 차트 업데이트 함수
        function updateChart(data) {
            // 차트를 초기화
            const ctx = document.getElementById('graph').getContext('2d');
            const labels = data.map(item => item[0]); // 첫 번째 요소는 시간
            const values = data.map(item => item[1]); // 두 번째 요소는 BPM 값

            // 기존 차트를 초기화
            if (window.myChart) {
                window.myChart.destroy();
            }

            // 새로운 차트를 생성
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Heart Rate',
                        data: values,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 페이지 로드 시 초기 차트 데이터를 로드
        fetch('/hourly-chart')
        .then(response => response.json())
        .then(responseData => {
            const { userEmail, data } = responseData;
            console.log('User Email:', userEmail); // 추가된 userEmail을 로그에 출력
            updateChart(data);
        })
        .catch(error => {
            console.error('Error fetching initial chart data:', error);
        });   
    </script>

    <script>
        // 캔버스 요소와 2D 컨텍스트 가져오기
        var canvas = document.getElementById('bar-graph');
        var ctx = canvas.getContext('2d');
        //차트 생성 함수
        function barChart(url) {
            const hourLabels = ['0','1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23'];
            /*fetch(url) 
                .then(response => response.json())
                .then(data => {
                    const hourLabels = data.map(item => item[0]);
                    const avgBPMs = data.map(item => item[1]);*/

                    var canvas = document.getElementById('bar-graph');
                    var ctx = canvas.getContext('2d');

                    new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: hourLabels,
                            datasets: [{
                                label: "활동",
                                fill: true,
                                data: [12, 19, 3, 5, 2, 3, 9, 10,12, 19, 3, 5, 2, 3, 9, 10,12, 19, 3, 5, 2, 3, 9, 10],
                                backgroundColor: '#ef476f',
                                barThickness: 20
                            },{
                                label: "수면",
                                fill: true,
                                data:  [2, 3, 20, 5, 1, 4, 6, 8,2, 3, 20, 5, 1, 4, 6, 8,2, 3, 20, 5, 1, 4, 6, 8],
                                backgroundColor: '#ffd166',
                                barThickness: 20
                            },{
                                label: "안정",
                                fill: true,
                                data: [3, 10, 13, 15, 22, 7, 11, 6,3, 10, 13, 15, 22, 7, 11, 6,3, 10, 13, 15, 22, 7, 11, 6],
                                backgroundColor: '#06d6a0',
                                barThickness: 20
                            },{
                                label: "평상",
                                fill: true,
                                data: [5, 2, 10, 20, 30, 14, 8, 12,5, 2, 10, 20, 30, 14, 8, 12,5, 2, 10, 20, 30, 14, 8, 12],
                                backgroundColor: '#118ab2',
                                barThickness: 20
                            },{
                                label: "운동",
                                fill: true,
                                data: [20, 30, 15, 10, 5, 9, 3, 1,20, 30, 15, 10, 5, 9, 3, 1,20, 30, 15, 10, 5, 9, 3, 1],
                                backgroundColor: '#073b4c',
                                barThickness: 20
                            }],
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(tooltipItem) {
                                            const datasetIndex = tooltipItem.datasetIndex;
                                            const datasets = tooltipItem.chart.data.datasets;
                                            const orderedDatasets = [datasets[4], datasets[3], datasets[2], datasets[1], datasets[0]]; // 운동, 평상, 안정, 수면, 활동 순서
                                            const dataset = orderedDatasets[datasetIndex];
                                            return dataset.label + ': ' + dataset.data[tooltipItem.dataIndex];
                                        },
                                        datasetLabel: function(context) {
                                            return context.dataset.label || '';
                                        }
                                    },
                                    itemSort: function(a, b) {
                                        const order = ['운동', '평상', '안정', '수면', '활동'];
                                        return order.indexOf(a.dataset.label) - order.indexOf(b.dataset.label);
                                    }
                                },
                                legend: {
                                    display: false,
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            scales: {
                                y: {
                                    stacked: true,
                                    grid: {
                                        drawBorder: false,
                                        display: true,
                                        drawOnChartArea: true,
                                        drawTicks: false,
                                        borderDash: [5, 5]
                                    },
                                    ticks: {
                                        display: true,
                                        padding: 0,
                                        color: '#fbfbfb',
                                        font: {
                                            size: 11,
                                            family: "Open Sans",
                                            style: 'normal',
                                            lineHeight: 2
                                        },
                                    }
                                },
                                x: {
                                    stacked: true,
                                    grid: {
                                        drawBorder: false,
                                        display: false,
                                        drawOnChartArea: false,
                                        drawTicks: false,
                                        borderDash: [5, 5]
                                    },
                                    ticks: {
                                        display: true,
                                        color: '#ccc',
                                        padding: 10,
                                        font: {
                                            size: 11,
                                            family: "Open Sans",
                                            style: 'normal',
                                            lineHeight: 2
                                        },
                                    }
                                },
                            },
                        },
                    });
                }/*)
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                });
        }*/

        barChart();
    
    </script>
    
    <script>
        // 캔버스 요소와 2D 컨텍스트 가져오기
        var canvas = document.getElementById('donut-graph');
        var ctx = canvas.getContext('2d');
        //차트 생성 함수

        var icons = [
            '../assets/img/normal.png', 
            '../assets/img/rest.png', 
            '../assets/img/sleep.png',
            '../assets/img/workout.png',
            '../assets/img/loading.gif'
        ];

        function donutChart(url) {
            let dailyTag;
            const hourLabels = ['활동', '수면', '안정', '평상', '운동'];
            dailyTag = [90, 75, 90, 98, 37];
            /*fetch(url) 
                .then(response => response.json())
                .then(data => {
                    const hourLabels = data.map(item => item[0]);
                    const dailyTag = data.map(item => item[1]);*/

                    var canvas = document.getElementById('donut-graph');
                    var ctx = canvas.getContext('2d');
                    var centerIcon = document.getElementById('centerIcon');
                    
                    const backgroundColors = [
                        '#ef476f','#ffd166','#06d6a0','#118ab2','#073b4c'
                    ];


                    new Chart(ctx, {
                        type: "doughnut",
                        data: {
                            labels: hourLabels,
                            datasets: [{
                                label: "BPM 박동수",
                                fill: true,
                                data: dailyTag,
                                backgroundColor: backgroundColors,
                                maxBarThickness: 6
                            }],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false,
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            hover: {
                                onHover: function(event, chartElement) {
                                    if (chartElement.length) {
                                        // 마우스가 데이터 포인트 위에 있을 때
                                        var index = chartElement[0].index;
                                        centerIcon.src = icons[index];
                                        centerIcon.style.display = 'block';
                                    } else {
                                        // 마우스가 데이터 포인트 밖에 있을 때
                                        centerIcon.style.display = 'none';
                                    }
                                }
                            },
                            layout: {
                                padding: {
                                    left: 0,
                                    right: 0,
                                    top: 0,
                                    bottom: 0
                                }
                            },
                            scales: {
                                y: {
                                    grid: {
                                        drawBorder: false,
                                        display: true,
                                        drawOnChartArea: true,
                                        drawTicks: false,
                                        borderDash: [5, 5]
                                    },
                                    ticks: {
                                        display: true,
                                        padding: 10,
                                        color: '#fbfbfb',
                                        font: {
                                            size: 11,
                                            family: "Open Sans",
                                            style: 'normal',
                                            lineHeight: 2
                                        },
                                    }
                                },
                                x: {
                                    grid: {
                                        drawBorder: false,
                                        display: false,
                                        drawOnChartArea: false,
                                        drawTicks: false,
                                        borderDash: [5, 5]
                                    },
                                    ticks: {
                                        display: false,
                                        color: '#ccc',
                                        padding: 20,
                                        font: {
                                            size: 11,
                                            family: "Open Sans",
                                            style: 'normal',
                                            lineHeight: 2
                                        },
                                    }
                                },
                            },
                        },
                    });
                }/*)
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                });
        }*/

        donutChart();
    
    </script>
</html>
